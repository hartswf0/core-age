<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAR ⟺ ONYX</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'SF Mono', monospace;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        .studio {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .controls {
            height: 60px;
            background: #0a0a0a;
            border-bottom: 1px solid #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            padding: 0 20px;
            flex-shrink: 0;
        }

        /* GAR selector */
        .gar-selector {
            display: flex;
            gap: 4px;
        }

        .gar-btn {
            width: 36px;
            height: 36px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            color: #666;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gar-btn:hover {
            background: #222;
            border-color: #333;
            transform: scale(1.05);
        }

        .gar-btn.active {
            background: #ff3366;
            border-color: #ff3366;
            color: #fff;
            box-shadow: 0 0 12px rgba(255, 51, 102, 0.5);
            transform: scale(1.1);
        }

        /* Slingshot mixer */
        .mixer {
            position: relative;
            width: 400px;
            height: 40px;
        }

        .mixer-track {
            width: 100%;
            height: 4px;
            background: #1a1a1a;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }

        .mixer-gate {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #ff3366;
            transform: translateX(-50%);
            opacity: 0.3;
        }

        .mixer-handle {
            position: absolute;
            top: 50%;
            width: 50px;
            height: 36px;
            background: linear-gradient(135deg, #ff3366 0%, #ff5588 100%);
            transform: translate(-50%, -50%);
            cursor: grab;
            box-shadow: 0 4px 12px rgba(255, 51, 102, 0.4);
            transition: box-shadow 0.1s, transform 0.1s;
            border-radius: 2px;
        }

        .mixer-handle:active {
            cursor: grabbing;
            box-shadow: 0 2px 6px rgba(255, 51, 102, 0.6);
            transform: translate(-50%, -50%) scale(0.95);
        }

        .mixer-handle.releasing {
            animation: elastic 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes elastic {
            0% {
                transform: translate(-50%, -50%) scaleX(1.2);
            }

            50% {
                transform: translate(-50%, -50%) scaleX(0.8);
            }

            100% {
                transform: translate(-50%, -50%) scaleX(1);
            }
        }

        .mixer-labels {
            position: absolute;
            width: 100%;
            top: -18px;
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: #666;
            letter-spacing: 1px;
        }

        /* Circuit dots */
        .circuit-dots {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 40px;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #1a1a1a;
            border: 2px solid #333;
            transition: all 0.3s;
        }

        .dot.active {
            background: #ff3366;
            border-color: #ff3366;
            box-shadow: 0 0 12px rgba(255, 51, 102, 0.8);
            animation: pulse 1s infinite;
        }

        .dot.mid {
            width: 12px;
            height: 12px;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.3);
            }
        }

        /* Status */
        .status {
            font-size: 10px;
            color: #666;
            letter-spacing: 1px;
            min-width: 100px;
            text-align: center;
        }

        .status.active {
            color: #ff3366;
            font-weight: 700;
        }

        /* Panels */
        .panels {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: #0a0a0a;
            overflow: hidden;
        }

        .panel {
            position: relative;
            background: #000;
            overflow: hidden;
        }

        .panel-label {
            position: absolute;
            top: 12px;
            left: 12px;
            font-size: 10px;
            letter-spacing: 2px;
            color: #666;
            text-transform: uppercase;
            z-index: 10;
            font-weight: 600;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Console */
        .console {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: rgba(0, 0, 0, 0.95);
            border-top: 1px solid #1a1a1a;
            padding: 8px 12px;
            font-family: 'SF Mono', monospace;
            font-size: 10px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .console.active {
            display: block;
        }

        .console-line {
            padding: 2px 0;
            opacity: 0.8;
        }

        .console-line.success {
            color: #3fb950;
        }

        .console-line.error {
            color: #ff3366;
        }

        .console-line.info {
            color: #58a6ff;
        }

        .console-toggle {
            position: fixed;
            bottom: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .console-toggle:hover {
            background: #222;
            color: #fff;
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border: 3px solid #1a1a1a;
            border-top-color: #ff3366;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
            z-index: 1000;
        }

        .loading.active {
            display: block;
        }

        @keyframes spin {
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .panels {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }

            .controls {
                gap: 20px;
                flex-wrap: wrap;
                height: auto;
                padding: 12px;
            }

            .mixer {
                width: 280px;
            }

            .gar-selector {
                order: -1;
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="studio">
        <div class="controls">
            <div class="gar-selector" id="gar-selector">
                <div class="gar-btn" data-gar="01">01</div>
                <div class="gar-btn" data-gar="02">02</div>
                <div class="gar-btn" data-gar="03">03</div>
                <div class="gar-btn" data-gar="04">04</div>
                <div class="gar-btn" data-gar="05">05</div>
                <div class="gar-btn" data-gar="06">06</div>
                <div class="gar-btn active" data-gar="07">07</div>
                <div class="gar-btn" data-gar="08">08</div>
            </div>

            <div class="mixer">
                <div class="mixer-labels"><span>GAR</span><span>TAO</span></div>
                <div class="mixer-track"></div>
                <div class="mixer-gate"></div>
                <div class="circuit-dots">
                    <div class="dot" id="dot-gar"></div>
                    <div class="dot mid" id="dot-gate"></div>
                    <div class="dot" id="dot-onyx"></div>
                </div>
                <div class="mixer-handle" id="mixer-handle"></div>
            </div>

            <div class="status" id="status">GAR-07</div>
        </div>

        <div class="panels">
            <div class="panel" id="panel-gar">
                <div class="panel-label">GAR · VISUAL</div>
                <iframe src="gar-07.html" id="gar-frame"></iframe>
            </div>
            <div class="panel" id="panel-onyx">
                <div class="panel-label">TAO · NARRATIVE</div>
                <iframe src="gar-tao.html" id="onyx-frame"></iframe>
            </div>
        </div>
    </div>

    <div class="console" id="console"></div>
    <div class="console-toggle" id="console-toggle">▲</div>
    <div class="loading" id="loading"></div>
    <audio id="sound" preload="auto">
        <source
            src="data:audio/wav;base64,UklGRhQDAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YfACAACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA=="
            type="audio/wav">
    </audio>

    <script>
        const $ = id => document.getElementById(id);
        const log = (msg, type = 'info') => {
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            $('console').appendChild(line);
            $('console').scrollTop = $('console').scrollHeight;
            console.log(`[STUDIO] ${msg}`);
        };

        const E = {
            garFrame: $('gar-frame'),
            onyxFrame: $('onyx-frame'),
            mixer: $('mixer-handle'),
            status: $('status'),
            loading: $('loading'),
            sound: $('sound'),
            dotGar: $('dot-gar'),
            dotGate: $('dot-gate'),
            dotOnyx: $('dot-onyx'),
            console: $('console'),
            consoleToggle: $('console-toggle')
        };

        let currentGar = '07';
        let mixPos = 0.5;
        let dragging = false;
        let velocity = 0;
        let dragStartX = 0;
        let lastMoveTime = 0;

        const haptic = () => navigator.vibrate && navigator.vibrate(20);
        const click = () => { E.sound.currentTime = 0; E.sound.volume = 0.3; E.sound.play().catch(() => { }); };

        // Console toggle
        E.consoleToggle.addEventListener('click', () => {
            E.console.classList.toggle('active');
            E.consoleToggle.textContent = E.console.classList.contains('active') ? '▼' : '▲';
        });

        // GAR selection
        document.querySelectorAll('.gar-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.gar-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentGar = btn.dataset.gar;
                E.garFrame.src = `gar-${currentGar}.html`;
                E.status.textContent = `GAR-${currentGar}`;
                log(`Switched to GAR-${currentGar}`, 'info');
                haptic();
                click();
            });
        });

        // Mixer with slingshot physics
        function updateMixer(animate = false) {
            if (animate) E.mixer.classList.add('releasing');
            else E.mixer.classList.remove('releasing');

            E.mixer.style.left = `${mixPos * 100}%`;

            if (mixPos < 0.4) {
                E.dotGar.classList.add('active');
                E.dotGate.classList.remove('active');
                E.dotOnyx.classList.remove('active');
            } else if (mixPos > 0.6) {
                E.dotGar.classList.remove('active');
                E.dotGate.classList.remove('active');
                E.dotOnyx.classList.add('active');
            } else {
                E.dotGar.classList.remove('active');
                E.dotGate.classList.add('active');
                E.dotOnyx.classList.remove('active');
            }

            if (mixPos > 0.45 && mixPos < 0.55) {
                E.status.textContent = 'TRANSMIT';
                E.status.classList.add('active');
            } else {
                E.status.textContent = mixPos < 0.5 ? `GAR-${currentGar}` : 'ONYX';
                E.status.classList.remove('active');
            }
        }

        E.mixer.addEventListener('mousedown', e => {
            dragging = true;
            dragStartX = e.clientX;
            lastMoveTime = Date.now();
            velocity = 0;
            e.preventDefault();
        });

        E.mixer.addEventListener('touchstart', e => {
            dragging = true;
            dragStartX = e.touches[0].clientX;
            lastMoveTime = Date.now();
            velocity = 0;
            e.preventDefault();
        });

        document.addEventListener('mousemove', e => {
            if (!dragging) return;
            const rect = E.mixer.parentElement.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const newPos = Math.max(0, Math.min(1, x / rect.width));

            // Calculate velocity
            const now = Date.now();
            const dt = (now - lastMoveTime) / 1000;
            velocity = (newPos - mixPos) / dt;
            lastMoveTime = now;

            mixPos = newPos;
            if (Math.abs(mixPos - 0.5) < 0.05) { mixPos = 0.5; haptic(); click(); }
            updateMixer();
        });

        document.addEventListener('touchmove', e => {
            if (!dragging) return;
            const rect = E.mixer.parentElement.getBoundingClientRect();
            const x = e.touches[0].clientX - rect.left;
            const newPos = Math.max(0, Math.min(1, x / rect.width));

            const now = Date.now();
            const dt = (now - lastMoveTime) / 1000;
            velocity = (newPos - mixPos) / dt;
            lastMoveTime = now;

            mixPos = newPos;
            if (Math.abs(mixPos - 0.5) < 0.05) { mixPos = 0.5; haptic(); click(); }
            updateMixer();
        });

        document.addEventListener('mouseup', () => {
            if (!dragging) return;
            dragging = false;

            // Slingshot: If velocity > threshold, shoot to nearest end
            if (Math.abs(velocity) > 1.5) {
                const target = velocity > 0 ? 1 : 0;
                log(`Slingshot! velocity=${velocity.toFixed(2)} → ${target === 1 ? 'ONYX' : 'GAR'}`, 'success');
                mixPos = target;
                updateMixer(true);
                haptic();
                click();
            } else if (mixPos > 0.45 && mixPos < 0.55) {
                transmit();
            }
        });

        document.addEventListener('touchend', () => {
            if (!dragging) return;
            dragging = false;

            if (Math.abs(velocity) > 1.5) {
                const target = velocity > 0 ? 1 : 0;
                log(`Slingshot! velocity=${velocity.toFixed(2)} → ${target === 1 ? 'ONYX' : 'GAR'}`, 'success');
                mixPos = target;
                updateMixer(true);
                haptic();
                click();
            } else if (mixPos > 0.45 && mixPos < 0.55) {
                transmit();
            }
        });

        async function transmit(directData = null) {
            E.loading.classList.add('active');
            log('Transmitting data...', 'info');
            click();

            try {
                let data;
                if (directData) {
                    data = directData;
                    log('Using direct data payload', 'info');
                } else {
                    const res = await fetch('http://localhost:3399/latest-gar');
                    data = await res.json();
                }

                if (data.channels?.length > 0 || data.cells) { // Handle both formats
                    // Normalize if needed (wrap single channel)
                    if (!data.channels && data.cells) {
                        data = { channels: [data] };
                    }

                    log(`Sending ${data.channels.length} channel(s) to ONYX`, 'success');
                    E.onyxFrame.contentWindow.postMessage({ type: 'IMPORT_GAR', data }, '*');

                    setTimeout(() => {
                        E.loading.classList.remove('active');
                        E.status.textContent = 'SYNCED';
                        log('Transmission complete!', 'success');
                        haptic();
                    }, 600);
                } else {
                    log('No GAR data available', 'error');
                    E.status.textContent = 'NO DATA';
                    E.loading.classList.remove('active');
                }
            } catch (err) {
                log(`Transmission failed: ${err.message}`, 'error');
                E.status.textContent = 'ERROR';
                E.loading.classList.remove('active');
            }
        }

        updateMixer();
        log('Studio initialized', 'success');

        // Listen for GAR exports
        window.addEventListener('message', async e => {
            if (e.data.type === 'GAR_EXPORT') {
                try {
                    log('GAR export detected, sending to server...', 'info');
                    await fetch('http://localhost:3399/gar-export', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(e.data.data)
                    });
                    log('GAR data ready for transmission', 'success');
                    E.status.textContent = 'GAR READY';

                    // Auto-transmitting for seamless flow
                    log('Auto-transmitting to TAO...', 'info');
                    await transmit(e.data.data);

                } catch (err) {
                    log(`Failed to send GAR export: ${err.message}`, 'error');
                }
            }
        });

        // Server status ping
        setInterval(async () => {
            try {
                const res = await fetch('http://localhost:3399/status');
                const data = await res.json();
                E.dotOnyx.style.opacity = data.hasData ? '1' : '0.3';
            } catch (e) {
                log('Lost connection to server', 'error');
            }
        }, 5000);
    </script>
</body>

</html>